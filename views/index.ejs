<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vote for Your Favorite Clip</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .audio-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .clip {
            text-align: center;
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 8px;
            width: 300px;
            background-color: #f8f9fa;
        }

        .selected {
            background-color: green !important;
            color: white;
        }

        .vote-button {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
        }

        .countdown {
            font-size: 1.5rem;
            font-weight: bold;
            color: red;
        }
    </style>
</head>

<body class="text-center container">
    <!-- Flash Messages -->
    <% if (messages) { %>
        <%- include('partials/messages', { messages: messages }) %>
            <% } %>
                <h1 class="my-4">Hlasuj! Jaký klip je lepšejší?</h1>
                <p class="lead">Stále se pře: <strong>
                        <%= remainingClips %> klipů
                    </strong></p>
                <p class="countdown" id="countdown">Čas na toto hlasování: 02:00</p>
                <div class="audio-container d-flex justify-content-center">
                    <% clips.forEach((clip, index)=> { %>
                        <div class="clip card p-3">
                            <h2 class="card-title">
                                <%= clip.displayName %>
                            </h2>
                            <audio controls class="w-100 my-2">
                                <source src="/files/<%= clip.name %>" type="audio/mp3">
                                Your browser does not support the audio element.
                            </audio>
                            <button class="select-button btn btn-outline-primary mt-2"
                                data-index="<%= index %>">TENHLE</button>
                        </div>
                        <% }); %>
                </div>

                <button class="vote-button btn btn-lg btn-primary">Hlasovat!</button>
                <form id="voteForm" action="/api/vote" method="POST" style="display: none;">
                    <input type="hidden" name="clip" id="clipInput">
                </form>
                <!-- Bootstrap JS -->
                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

                <script>
                    let selectedClip = null;
                    let timeRemaining = <%= time %>;
                    document.querySelectorAll(".select-button").forEach(button => {
                        button.addEventListener("click", function () {
                            document.querySelectorAll(".select-button").forEach(btn => btn.classList.remove("selected", "btn-success"));
                            this.classList.add("selected", "btn-success");
                            selectedClip = this.dataset.index;
                        });
                    });
                    function updateCountdown() {
                        let minutes = Math.floor(timeRemaining / 60);
                        let seconds = timeRemaining % 60;
                        document.getElementById("countdown").textContent = `Time remaining: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                        if (timeRemaining > -1) {
                            timeRemaining--;
                            setTimeout(updateCountdown, 1000);
                        } else {
                            location.reload();
                        }
                    }
                    updateCountdown();

                    document.querySelector(".vote-button").addEventListener("click", function () {
                        if (selectedClip === null) {
                            alert("Please select a clip before voting!");
                        } else {
                            document.getElementById("clipInput").value = selectedClip;
                            // Submit the form (this will trigger a normal POST request)
                            document.getElementById("voteForm").submit();
                        }
                    });
                </script>
</body>

</html>